image: python:3.10-slim

variables:
  POSTGRES_DB: test_db
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password
  
services:
  - postgres:13
  - redis:7-alpine

stages:
  - test
  - security
  - build
  - deploy

cache:
  paths:
    - .venv/
    - .cache/pip/
  key: ${CI_COMMIT_REF_SLUG}

before_script:
  - apt-get update && apt-get install -y curl gcc libpq-dev
  - python -m pip install --upgrade pip
  - pip install poetry
  - poetry config virtualenvs.in-project true
  - poetry install --no-interaction

.test_template: &test_template
  stage: test
  script:
    - cp .env.example .env.test
    - echo "ENVIRONMENT=test" >> .env.test
    - poetry run pytest tests/ -v --cov=src --cov-report=xml
  artifacts:
    when: always
    paths:
      - coverage.xml
      - htmlcov/
    reports:
      junit: junit.xml
      cobertura: coverage.xml

unit_tests:
  <<: *test_template
  script:
    - poetry run pytest tests/unit/ -v

integration_tests:
  <<: *test_template
  script:
    - poetry run pytest tests/integration/ -v

lint:
  stage: test
  script:
    - poetry run black --check src tests
    - poetry run flake8 src tests
    - poetry run isort --check-only src tests
    - poetry run mypy src

security_scan:
  stage: security
  script:
    - pip install safety bandit
    - safety check -r requirements.txt
    - bandit -r src -f json
  artifacts:
    when: always
    paths:
      - bandit-output.json

build_docker:
  stage: build
  image: docker:20.10
  services:
    - docker:20.10-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main

deploy_staging:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - curl -X POST $SUPABASE_STAGING_WEBHOOK
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop

deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - curl -X POST $SUPABASE_PRODUCTION_WEBHOOK
  environment:
    name: production
    url: https://production.example.com
  only:
    - main
  when: manual